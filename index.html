<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Notulen - Yayasan Miftahus Sunnah</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/a/ACg8ocKSIlJ0_E91_xjllpIqVTAtx0cSsvrdX9MFQJcUf1Iumwz_u8c=s96-c-rg-br100">

    <!-- LOAD SCRIPTS -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF GENERATOR LIBRARY (jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 2px solid #059669; color: #059669; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { color: #374151; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #059669; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Form Inputs */
        .input-std { width: 100%; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.2s; }
        .input-std:focus { outline: none; border-color: #10b981; ring: 2px solid #10b981; }
    </style>
</head>
<body>
    <div id="root">
        <div style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #4b5563;">
            <div class="spinner" style="margin-bottom: 1rem;"></div>
            <p>Memuat Aplikasi...</p>
        </div>
    </div>

    <script type="text/babel">
        // --- CONSTANTS ---
        const LOGO_URL = "https://lh3.googleusercontent.com/a/ACg8ocKSIlJ0_E91_xjllpIqVTAtx0cSsvrdX9MFQJcUf1Iumwz_u8c=s96-c-rg-br100";

        // --- ICON SYSTEM ---
        const ICON_PATHS = {
            Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>,
            Users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></>,
            FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
            CheckSquare: <><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></>,
            Search: <><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>,
            Plus: <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
            ChevronRight: <><polyline points="9 18 15 12 9 6"></polyline></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>,
            Clock: <><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>,
            MapPin: <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></>,
            Menu: <><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></>,
            X: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
            User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></>,
            CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>,
            AlertCircle: <><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>,
            LayoutDashboard: <><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></>,
            Settings: <><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>,
            FileBox: <><path d="M14.5 22H18a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M6 16.5h2"></path><path d="M11 20H4a2 2 0 0 1-2-2V7"></path><circle cx="10" cy="12.5" r="2.5"></circle></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></>,
            Trash2: <><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>
        };

        const Icon = ({ name, size = 24, color = "currentColor", className = "", ...props }) => {
            if (!ICON_PATHS[name]) return null;
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{ICON_PATHS[name]}</svg>;
        };

        const { useState, useEffect, useMemo } = React;
        const Calendar = (props) => <Icon name="Calendar" {...props} />;
        const Users = (props) => <Icon name="Users" {...props} />;
        const FileText = (props) => <Icon name="FileText" {...props} />;
        const CheckSquare = (props) => <Icon name="CheckSquare" {...props} />;
        const Search = (props) => <Icon name="Search" {...props} />;
        const Plus = (props) => <Icon name="Plus" {...props} />;
        const ChevronRight = (props) => <Icon name="ChevronRight" {...props} />;
        const Download = (props) => <Icon name="Download" {...props} />;
        const Clock = (props) => <Icon name="Clock" {...props} />;
        const MapPin = (props) => <Icon name="MapPin" {...props} />;
        const Menu = (props) => <Icon name="Menu" {...props} />;
        const X = (props) => <Icon name="X" {...props} />;
        const User = (props) => <Icon name="User" {...props} />;
        const LogOut = (props) => <Icon name="LogOut" {...props} />;
        const CheckCircle = (props) => <Icon name="CheckCircle" {...props} />;
        const AlertCircle = (props) => <Icon name="AlertCircle" {...props} />;
        const LayoutDashboard = (props) => <Icon name="LayoutDashboard" {...props} />;
        const Settings = (props) => <Icon name="Settings" {...props} />;
        const FileBox = (props) => <Icon name="FileBox" {...props} />;
        const Edit = (props) => <Icon name="Edit" {...props} />;
        const Trash2 = (props) => <Icon name="Trash2" {...props} />;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhdtK3RgsprXUrHfBJkudHiii3HMcHX6E",
            authDomain: "notulen-d96dd.firebaseapp.com",
            projectId: "notulen-d96dd",
            storageBucket: "notulen-d96dd.firebasestorage.app",
            messagingSenderId: "96808237456",
            appId: "1:96808237456:web:e680b7d471da4a71a51b15",
            measurementId: "G-13K7MKVD8G"
        };

        let auth = null;
        let db = null;
        try {
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            }
        } catch (e) { console.error("Firebase init error:", e); }

        // --- COMPONENTS ---
        const Alert = ({ children, type = 'info' }) => {
            const colors = { info: 'bg-blue-50 text-blue-700 border-blue-200', error: 'bg-red-50 text-red-700 border-red-200', success: 'bg-green-50 text-green-700 border-green-200' };
            return <div className={`p-4 mb-4 rounded-md border ${colors[type]} text-sm flex items-start`}><div className="mr-2 mt-0.5"><AlertCircle size={16}/></div><div>{children}</div></div>;
        };

        const StatusBadge = ({ status }) => {
            const styles = { scheduled: 'bg-blue-100 text-blue-800', 'in-progress': 'bg-yellow-100 text-yellow-800', completed: 'bg-green-100 text-green-800', archived: 'bg-gray-100 text-gray-800' };
            const labels = { scheduled: 'Terjadwal', 'in-progress': 'Berlangsung', completed: 'Selesai', archived: 'Diarsipkan' };
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-semibold ${styles[status] || styles.archived}`}>{labels[status] || status}</span>;
        };

        // --- SETTINGS COMPONENT ---
        const SettingsPage = ({ user }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [name, setName] = useState(user.displayName || '');
            const [email, setEmail] = useState(user.email || '');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                setName(user.displayName || '');
                setEmail(user.email || '');
            }, [user]);

            const handleSave = async () => {
                setLoading(true);
                try {
                    if (user.updateProfile) {
                        const updates = [];
                        if (name !== user.displayName) updates.push(user.updateProfile({ displayName: name }));
                        if (email !== user.email) updates.push(user.updateEmail(email));
                        
                        if (updates.length > 0) {
                            await Promise.all(updates);
                            alert("Profil berhasil diperbarui! Silakan refresh halaman jika data belum berubah.");
                        } else {
                            alert("Tidak ada perubahan yang perlu disimpan.");
                        }
                    } else {
                        alert("Mode Demo: Profil diperbarui (Simulasi). Data asli tidak diubah.");
                    }
                    setIsEditing(false);
                } catch (err) {
                    console.error("Profile Update Error:", err);
                    let msg = "Gagal memperbarui profil: " + err.message;
                    if (err.code === 'auth/requires-recent-login') {
                        msg = "Demi keamanan, ganti email memerlukan login ulang. Silakan logout dan login kembali, lalu coba lagi.";
                    } else if (err.code === 'auth/network-request-failed') {
                        msg = "Gagal terhubung ke server. Periksa koneksi internet Anda.";
                    }
                    alert(msg);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fade-in space-y-6">
                    <h2 className="text-2xl font-bold text-gray-900">Pengaturan</h2>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="text-lg font-bold text-gray-800">Profil Pengguna</h3>
                            {!isEditing ? (
                                <button onClick={() => setIsEditing(true)} className="text-emerald-600 hover:text-emerald-700 text-sm font-medium flex items-center transition"><Edit size={16} className="mr-1"/> Edit Profil</button>
                            ) : (
                                <div className="flex gap-2">
                                    <button onClick={() => { setIsEditing(false); setName(user.displayName||''); setEmail(user.email||''); }} className="text-gray-500 hover:text-gray-700 text-sm px-3 py-1 rounded bg-gray-100">Batal</button>
                                    <button onClick={handleSave} disabled={loading} className="bg-emerald-600 text-white text-sm px-3 py-1 rounded hover:bg-emerald-700 font-medium">{loading ? 'Menyimpan...' : 'Simpan'}</button>
                                </div>
                            )}
                        </div>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-500 mb-1">Nama Lengkap</label>{isEditing ? <input type="text" className="input-std" value={name} onChange={(e) => setName(e.target.value)} placeholder="Nama Lengkap" /> : <p className="font-medium text-gray-900">{user.displayName || '(Belum ada nama)'}</p>}</div>
                            <div><label className="block text-sm font-medium text-gray-500 mb-1">Email</label>{isEditing ? <input type="email" className="input-std" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" /> : <p className="font-medium text-gray-900">{user.email}</p>}</div>
                            <div><label className="block text-sm font-medium text-gray-500 mb-1">Peran</label><span className="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded-full font-bold">Admin</span></div>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Aplikasi</h3><div className="flex items-center justify-between py-2"><div><p className="font-medium text-gray-900">Versi Aplikasi</p><p className="text-sm text-gray-500">v1.0.0 (Beta)</p></div></div></div>
                </div>
            );
        };

        // --- SEARCH COMPONENT ---
        const SearchArchives = ({ meetings, onNavigateDetail }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const filteredMeetings = meetings.filter(m => m.title.toLowerCase().includes(searchTerm.toLowerCase()) || (m.location && m.location.toLowerCase().includes(searchTerm.toLowerCase())));
            return (
                <div className="animate-fade-in space-y-6">
                    <h2 className="text-2xl font-bold text-gray-900">Arsip Notulen</h2>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div className="relative"><div className="absolute left-3 top-3 text-gray-400"><Search size={20} /></div><input type="text" className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Cari berdasarkan judul atau lokasi..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                    </div>
                    <div className="space-y-4">
                        {filteredMeetings.length > 0 ? filteredMeetings.map(meeting => (
                            <div key={meeting.id} onClick={() => onNavigateDetail(meeting.id)} className="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:bg-blue-50/30 cursor-pointer transition flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div className="flex gap-4 items-start"><div className="bg-gray-100 p-2 rounded-lg text-center min-w-[60px]"><p className="text-xs text-gray-500 uppercase font-bold">{new Date(meeting.date).toLocaleString('id-ID', { month: 'short' })}</p><p className="text-xl font-bold text-gray-800">{new Date(meeting.date).getDate()}</p></div><div><h4 className="font-bold text-gray-800 text-lg">{meeting.title}</h4><div className="flex gap-3 mt-1 text-sm text-gray-500"><span className="flex items-center"><MapPin size={14} className="mr-1"/> {meeting.location}</span><span className="flex items-center"><User size={14} className="mr-1"/> {meeting.leader_name}</span></div></div></div><StatusBadge status={meeting.status} />
                            </div>
                        )) : <div className="text-center py-12 text-gray-500 bg-white rounded-xl border border-gray-200 border-dashed"><FileText size={48} className="mx-auto text-gray-300 mb-3"/><p>Tidak ditemukan notulen yang cocok.</p></div>}
                    </div>
                </div>
            );
        };

        // --- MANAGE ATTACHMENTS COMPONENT ---
        const ManageAttachments = () => {
            return (
                <div className="animate-fade-in space-y-6">
                    <h2 className="text-2xl font-bold text-gray-900">Kelola Lampiran</h2>
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200 text-center border-dashed border-2 border-gray-300 hover:border-emerald-500 transition-colors cursor-pointer group">
                        <div className="w-16 h-16 bg-emerald-50 group-hover:bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 transition"><Download size={32} className="rotate-180" /></div><h3 className="text-lg font-medium text-gray-900">Upload Lampiran Baru</h3><p className="text-gray-500 mt-1 text-sm">Klik atau tarik file ke sini (PDF, DOCX, JPG)</p>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="p-6 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center"><h3 className="font-bold text-gray-800">File Tersimpan</h3><span className="text-xs font-medium text-gray-500 bg-gray-200 px-2 py-1 rounded-full">3 File</span></div>
                        <div className="divide-y divide-gray-100">
                            {[{ name: 'Undangan_Rapat_Juni.pdf', size: '1.2 MB', date: '2024-06-18' }, { name: 'Laporan_Keuangan_Qurban.xlsx', size: '450 KB', date: '2024-06-20' }, { name: 'Foto_Dokumentasi_1.jpg', size: '2.4 MB', date: '2024-06-20' }].map((file, i) => (
                                <div key={i} className="p-4 flex items-center justify-between hover:bg-gray-50 transition">
                                    <div className="flex items-center gap-4"><div className="bg-blue-100 text-blue-600 p-3 rounded-lg"><FileText size={20}/></div><div><p className="font-medium text-gray-800">{file.name}</p><p className="text-xs text-gray-500">{file.size} • Diupload pada {file.date}</p></div></div><div className="flex gap-2"><button className="p-2 text-gray-400 hover:text-emerald-600 rounded-full hover:bg-emerald-50 transition" title="Download"><Download size={18}/></button><button className="p-2 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-50 transition" title="Hapus"><Trash2 size={18}/></button></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- FORM BUAT RAPAT ---
        const CreateMeetingForm = ({ onSave, onCancel, loading }) => {
            const [formData, setFormData] = useState({ title: '', date: '', time: '', location: '', type: 'Rapat Rutin', leader_name: '' });
            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
            const handleSubmit = (e) => { e.preventDefault(); onSave({ ...formData, date: `${formData.date}T${formData.time}:00`, status: 'scheduled', agenda: [], minutes: [], decisions: [], action_items: [] }); };

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 animate-fade-in max-w-2xl mx-auto">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-gray-900">Buat Rapat Baru</h2><button onClick={onCancel} className="text-gray-400 hover:text-gray-600"><X size={24} /></button></div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Judul Rapat</label><input type="text" name="title" required className="input-std" onChange={handleChange} /></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" name="date" required className="input-std" onChange={handleChange} /></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Jam</label><input type="time" name="time" required className="input-std" onChange={handleChange} /></div></div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Lokasi</label><input type="text" name="location" required className="input-std" onChange={handleChange} /></div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Jenis Rapat</label><select name="type" className="input-std" onChange={handleChange}><option>Rapat Rutin</option><option>Rapat Evaluasi</option><option>Rapat Tahunan</option><option>Rapat Luar Biasa</option></select></div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Pimpinan Rapat</label><input type="text" name="leader_name" required className="input-std" onChange={handleChange} /></div>
                        <div className="pt-4 flex justify-end gap-3"><button type="button" onClick={onCancel} className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Batal</button><button type="submit" disabled={loading} className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium">{loading ? 'Menyimpan...' : 'Simpan Rapat'}</button></div>
                    </form>
                </div>
            );
        };

        // --- FORM EDIT/TULIS NOTULEN ---
        const EditMeetingForm = ({ meeting, onSave, onCancel, loading }) => {
            const [data, setData] = useState(meeting);
            const [activeTab, setActiveTab] = useState('info');

            const handleChange = (e) => setData({ ...data, [e.target.name]: e.target.value });
            const handleDateChange = (e) => {
                const currentDateTime = data.date || new Date().toISOString();
                const timePart = currentDateTime.split('T')[1] || '00:00:00';
                setData({ ...data, date: `${e.target.value}T${timePart}` });
            };
            const handleTimeChange = (e) => {
                const currentDateTime = data.date || new Date().toISOString();
                const datePart = currentDateTime.split('T')[0];
                setData({ ...data, date: `${datePart}T${e.target.value}:00` });
            };

            const handleArrayChange = (field, index, value) => { const newArr = [...(data[field] || [])]; newArr[index] = value; setData({ ...data, [field]: newArr }); };
            const handleMinutesChange = (index, key, value) => { const newArr = [...(data.minutes || [])]; newArr[index] = { ...newArr[index], [key]: value }; setData({ ...data, minutes: newArr }); };
            const handleActionChange = (index, key, value) => { const newArr = [...(data.action_items || [])]; newArr[index] = { ...newArr[index], [key]: value }; setData({ ...data, action_items: newArr }); };
            const addItem = (field, emptyItem) => setData({ ...data, [field]: [...(data[field] || []), emptyItem] });
            const removeItem = (field, index) => { const newArr = [...data[field]]; newArr.splice(index, 1); setData({ ...data, [field]: newArr }); };

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 animate-fade-in">
                    <div className="flex justify-between items-center mb-6"><div><h2 className="text-xl font-bold text-gray-900">Edit Rapat & Notulen</h2><p className="text-sm text-gray-500">{data.title}</p></div><div className="flex gap-2"><button onClick={onCancel} className="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-100">Batal</button><button onClick={() => onSave(data)} disabled={loading} className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium">{loading ? 'Menyimpan...' : 'Simpan Perubahan'}</button></div></div>
                    <div className="flex border-b border-gray-200 mb-6 overflow-x-auto">
                        {['info', 'agenda', 'minutes', 'decisions', 'actions'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-3 font-medium text-sm whitespace-nowrap ${activeTab === tab ? 'border-b-2 border-emerald-600 text-emerald-600 bg-emerald-50' : 'text-gray-500 hover:bg-gray-50'}`}>
                                {tab === 'info' && '1. Info Rapat'}
                                {tab === 'agenda' && '2. Agenda'}
                                {tab === 'minutes' && '3. Jalannya Rapat'}
                                {tab === 'decisions' && '4. Keputusan'}
                                {tab === 'actions' && '5. Tindak Lanjut'}
                            </button>
                        ))}
                    </div>
                    <div className="space-y-4">
                        {activeTab === 'info' && (
                            <div className="space-y-4 animate-fade-in">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Judul Rapat</label><input type="text" name="title" className="input-std" value={data.title} onChange={handleChange} /></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" className="input-std" value={data.date ? data.date.split('T')[0] : ''} onChange={handleDateChange} /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Jam</label><input type="time" className="input-std" value={data.date ? data.date.split('T')[1].substring(0,5) : ''} onChange={handleTimeChange} /></div>
                                </div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Lokasi</label><input type="text" name="location" className="input-std" value={data.location} onChange={handleChange} /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Jenis Rapat</label><select name="type" className="input-std" value={data.type} onChange={handleChange}><option>Rapat Rutin</option><option>Rapat Evaluasi</option><option>Rapat Tahunan</option><option>Rapat Luar Biasa</option></select></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Pimpinan Rapat</label><input type="text" name="leader_name" className="input-std" value={data.leader_name} onChange={handleChange} /></div>
                            </div>
                        )}
                        {activeTab === 'agenda' && (<>{data.agenda?.map((item, i) => (<div key={i} className="flex gap-2 items-center"><span className="text-gray-400 font-bold w-6">{i+1}.</span><input type="text" className="input-std" value={item} onChange={e => handleArrayChange('agenda', i, e.target.value)} placeholder="Isi agenda..." /><button onClick={() => removeItem('agenda', i)} className="text-red-400 hover:text-red-600"><X size={20}/></button></div>))}<button onClick={() => addItem('agenda', '')} className="text-emerald-600 text-sm font-medium flex items-center hover:underline"><Plus size={16} className="mr-1"/> Tambah Agenda</button></>)}
                        {activeTab === 'minutes' && (<>{data.minutes?.map((m, i) => (<div key={i} className="bg-gray-50 p-4 rounded-lg border relative group"><button onClick={() => removeItem('minutes', i)} className="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition"><X size={16}/></button><div className="mb-2"><label className="text-xs font-bold text-gray-500 uppercase">Pembicara</label><input type="text" className="input-std text-sm" value={m.speaker} placeholder="Contoh: Ketua Yayasan" onChange={e => handleMinutesChange(i, 'speaker', e.target.value)} /></div><div><label className="text-xs font-bold text-gray-500 uppercase">Isi Pembicaraan</label><textarea className="input-std text-sm" rows="3" value={m.content} placeholder="Menyampaikan bahwa..." onChange={e => handleMinutesChange(i, 'content', e.target.value)} /></div></div>))}<button onClick={() => addItem('minutes', {speaker: '', content: ''})} className="text-emerald-600 text-sm font-medium flex items-center hover:underline"><Plus size={16} className="mr-1"/> Tambah Catatan Diskusi</button></>)}
                        {activeTab === 'decisions' && (<>{data.decisions?.map((item, i) => (<div key={i} className="flex gap-2 items-start"><div className="mt-3 w-5 h-5 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-xs font-bold flex-shrink-0">✓</div><textarea className="input-std" rows="2" value={item} onChange={e => handleArrayChange('decisions', i, e.target.value)} placeholder="Keputusan yang disepakati..." /><button onClick={() => removeItem('decisions', i)} className="text-red-400 hover:text-red-600 mt-2"><X size={20}/></button></div>))}<button onClick={() => addItem('decisions', '')} className="text-emerald-600 text-sm font-medium flex items-center hover:underline"><Plus size={16} className="mr-1"/> Tambah Keputusan</button></>)}
                        {activeTab === 'actions' && (<>{data.action_items?.map((item, i) => (<div key={i} className="bg-yellow-50/50 border border-yellow-100 p-4 rounded-lg relative group mb-4"><button onClick={() => removeItem('action_items', i)} className="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition"><X size={16}/></button><div className="space-y-3"><div><label className="text-xs font-bold text-gray-500">Tugas / Action Item</label><input type="text" className="input-std" placeholder="Apa yang harus dilakukan?" value={item.task} onChange={e => handleActionChange(i, 'task', e.target.value)} /></div><div className="flex gap-3"><div className="flex-1"><label className="text-xs font-bold text-gray-500">PIC (Penanggung Jawab)</label><input type="text" className="input-std" placeholder="Nama..." value={item.assignee} onChange={e => handleActionChange(i, 'assignee', e.target.value)} /></div><div className="w-32"><label className="text-xs font-bold text-gray-500">Deadline</label><input type="date" className="input-std" value={item.deadline ? new Date(item.deadline).toISOString().substr(0,10) : ''} onChange={e => handleActionChange(i, 'deadline', e.target.value)} /></div><div className="w-32"><label className="text-xs font-bold text-gray-500">Status</label><select className="input-std" value={item.status} onChange={e => handleActionChange(i, 'status', e.target.value)}><option value="pending">Pending</option><option value="in-progress">Proses</option><option value="done">Selesai</option></select></div></div></div></div>))}<button onClick={() => addItem('action_items', {task: '', assignee: '', deadline: '', status: 'pending'})} className="text-emerald-600 text-sm font-medium flex items-center hover:underline"><Plus size={16} className="mr-1"/> Tambah Tindak Lanjut</button></>)}
                    </div>
                </div>
            );
        };

        const Login = ({ onLogin, loading, error }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            return (
                <div className="min-h-screen flex items-center justify-center bg-emerald-900 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md animate-fade-in">
                        <div className="text-center mb-8">
                            <img src={LOGO_URL} className="w-20 h-20 rounded-full mx-auto mb-4 bg-white shadow-sm" alt="Logo" />
                            <h1 className="text-2xl font-bold text-gray-800">Sistem Notulen</h1>
                            <p className="text-gray-500">Yayasan Miftahus Sunnah</p>
                        </div>
                        {error && <Alert type="error">{error}</Alert>}
                        <form onSubmit={(e) => { e.preventDefault(); onLogin(email, password); }} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" required className="input-std" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" required className="input-std" value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                            <button type="submit" disabled={loading} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg">{loading ? 'Memproses...' : 'Masuk Aplikasi'}</button>
                        </form>
                        <div className="mt-6 text-center"><button onClick={() => onLogin('demo', 'demo')} className="text-sm text-emerald-600 hover:underline">Masuk dengan Mode Demo (Tanpa Password)</button></div>
                    </div>
                </div>
            );
        };

        const DashboardStats = ({ meetings }) => {
            const stats = useMemo(() => {
                const total = meetings.length;
                const completed = meetings.filter(m => m.status === 'completed').length;
                const scheduled = meetings.filter(m => m.status === 'scheduled').length;
                const pendingActions = meetings.reduce((acc, curr) => acc + (curr.action_items?.filter(a => a.status !== 'done').length || 0), 0);
                return { total, completed, scheduled, pendingActions };
            }, [meetings]);

            return (
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between"><div><p className="text-gray-500 text-sm">Rapat Terjadwal</p><h3 className="text-2xl font-bold text-gray-800">{stats.scheduled}</h3></div><div className="bg-blue-100 p-3 rounded-lg text-blue-600"><Calendar size={24}/></div></div>
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between"><div><p className="text-gray-500 text-sm">Tugas Pending</p><h3 className="text-2xl font-bold text-gray-800">{stats.pendingActions}</h3></div><div className="bg-yellow-100 p-3 rounded-lg text-yellow-600"><CheckSquare size={24}/></div></div>
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between"><div><p className="text-gray-500 text-sm">Arsip Notulen</p><h3 className="text-2xl font-bold text-gray-800">{stats.completed}</h3></div><div className="bg-emerald-100 p-3 rounded-lg text-emerald-600"><FileText size={24}/></div></div>
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between"><div><p className="text-gray-500 text-sm">Total Rapat</p><h3 className="text-2xl font-bold text-gray-800">{stats.total}</h3></div><div className="bg-purple-100 p-3 rounded-lg text-purple-600"><Users size={24}/></div></div>
                </div>
            );
        };

        const MeetingDetail = ({ meeting, onBack, onEdit }) => {
            const [activeTab, setActiveTab] = useState('minutes');
            if (!meeting) return <div>Loading...</div>;

            const handleDownloadPDF = () => {
                if (!window.jspdf) { alert("Library PDF belum siap."); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const margin = 20;
                let y = 20;
                const lineHeight = 7;
                const pageWidth = doc.internal.pageSize.getWidth();
                const maxTextWidth = pageWidth - (margin * 2);

                doc.setFontSize(16); doc.setFont("helvetica", "bold");
                doc.text("NOTULEN RAPAT", pageWidth / 2, y, { align: "center" }); y += 10;
                doc.text("YAYASAN MIFTAHUS SUNNAH", pageWidth / 2, y, { align: "center" }); y += 15;

                doc.setFontSize(11); doc.setFont("helvetica", "normal");
                const metaData = [`Judul: ${meeting.title}`, `Tanggal: ${new Date(meeting.date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`, `Waktu: ${new Date(meeting.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})} WIB`, `Lokasi: ${meeting.location}`, `Pimpinan: ${meeting.leader_name}`, `Jenis: ${meeting.type}`];
                metaData.forEach(line => { doc.text(line, margin, y); y += lineHeight; });
                
                y += 5; doc.line(margin, y, pageWidth - margin, y); y += 10;

                const addSection = (title, contentArray, formatter) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.setFont("helvetica", "bold"); doc.text(title, margin, y); y += lineHeight;
                    doc.setFont("helvetica", "normal");
                    if (!contentArray || contentArray.length === 0) { doc.text("- (Tidak ada data)", margin + 5, y); y += lineHeight; } 
                    else {
                        contentArray.forEach((item, index) => {
                            const text = formatter(item, index);
                            const splitText = doc.splitTextToSize(text, maxTextWidth - 5);
                            if (y + (splitText.length * lineHeight) > 280) { doc.addPage(); y = 20; }
                            doc.text(splitText, margin + 5, y);
                            y += (splitText.length * lineHeight) + 2;
                        });
                    }
                    y += 5;
                };

                addSection("1. AGENDA RAPAT", meeting.agenda, (item, i) => `${i + 1}. ${item}`);
                addSection("2. JALANNYA RAPAT", meeting.minutes, (item) => `${item.speaker}: ${item.content}`);
                addSection("3. KEPUTUSAN", meeting.decisions, (item, i) => `${i + 1}. ${item}`);
                addSection("4. TINDAK LANJUT", meeting.action_items, (item) => `[${item.status === 'done' ? 'Selesai' : 'Proses'}] ${item.task} (PIC: ${item.assignee}) - DL: ${item.deadline ? new Date(item.deadline).toLocaleDateString('id-ID') : '-'}`);

                doc.save(`Notulen_${meeting.date.split('T')[0]}.pdf`);
            };

            return (
                <div className="space-y-6 animate-fade-in">
                    <button onClick={onBack} className="text-gray-500 hover:text-emerald-600 flex items-center text-sm mb-2 font-medium"><ChevronRight className="rotate-180 mr-1" size={16} /> Kembali ke Dashboard</button>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <div className="flex items-center gap-2 mb-2"><StatusBadge status={meeting.status} /><span className="text-sm text-gray-500 font-medium">{meeting.type}</span></div>
                                <h1 className="text-2xl md:text-3xl font-bold text-gray-900">{meeting.title}</h1>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={onEdit} className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-emerald-700 flex items-center shadow-sm"><Edit size={16} className="mr-2" /> Edit Rapat / Notulen</button>
                                <button onClick={handleDownloadPDF} className="border border-gray-300 bg-white text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center shadow-sm"><Download size={16} className="mr-2" /> PDF</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm border-t pt-4">
                            <div className="flex items-start gap-3"><Calendar className="text-emerald-600 mt-0.5" size={18} /><div><p className="text-gray-500">Waktu</p><p className="font-medium text-gray-800">{new Date(meeting.date).toLocaleDateString('id-ID')}</p><p className="text-gray-600">{new Date(meeting.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})} WIB</p></div></div>
                            <div className="flex items-start gap-3"><MapPin className="text-emerald-600 mt-0.5" size={18} /><div><p className="text-gray-500">Lokasi</p><p className="font-medium text-gray-800">{meeting.location}</p></div></div>
                            <div className="flex items-start gap-3"><User className="text-emerald-600 mt-0.5" size={18} /><div><p className="text-gray-500">Pimpinan</p><p className="font-medium text-gray-800">{meeting.leader_name}</p></div></div>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[400px]">
                        <div className="flex border-b border-gray-200">
                            {['minutes', 'decisions', 'actions'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-4 text-sm font-medium text-center transition-colors ${activeTab === tab ? 'border-b-2 border-emerald-600 text-emerald-700 bg-emerald-50/50' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`}>
                                    {tab === 'minutes' && 'Jalannya Rapat'} {tab === 'decisions' && `Keputusan (${meeting.decisions?.length || 0})`} {tab === 'actions' && `Tindak Lanjut (${meeting.action_items?.length || 0})`}
                                </button>
                            ))}
                        </div>
                        <div className="p-6">
                            {activeTab === 'minutes' && (
                                <div className="space-y-8 animate-fade-in">
                                    <div><h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Agenda</h3><ul className="space-y-2">{meeting.agenda?.length ? meeting.agenda.map((item, i) => <li key={i} className="flex gap-3"><span className="bg-emerald-100 text-emerald-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">{i+1}</span>{item}</li>) : <p className="text-gray-400 italic">Belum ada agenda. Klik "Tulis Notulen" untuk mengisi.</p>}</ul></div>
                                    <hr className="border-gray-100"/>
                                    <div><h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Catatan</h3><div className="space-y-4">{meeting.minutes?.length ? meeting.minutes.map((m, i) => <div key={i} className="bg-gray-50 p-4 rounded-lg"><p className="text-xs font-bold text-emerald-700 mb-1">{m.speaker}</p><p>{m.content}</p></div>) : <p className="text-gray-400 italic">Belum ada catatan.</p>}</div></div>
                                </div>
                            )}
                            {activeTab === 'decisions' && (<div className="space-y-4">{meeting.decisions?.length ? meeting.decisions.map((d, i) => <div key={i} className="flex gap-4 p-4 border border-green-200 bg-green-50 rounded-lg"><div className="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 text-xs font-bold">✓</div><p className="font-medium">{d}</p></div>) : <p className="text-gray-400 italic text-center py-8">Belum ada keputusan.</p>}</div>)}
                            {activeTab === 'actions' && (<div className="overflow-hidden rounded-lg border border-gray-200"><table className="w-full text-sm text-left"><thead className="bg-gray-50 border-b"><tr><th className="px-6 py-3">Tugas</th><th className="px-6 py-3">PIC</th><th className="px-6 py-3">Deadline</th><th className="px-6 py-3">Status</th></tr></thead><tbody className="divide-y divide-gray-100">{meeting.action_items?.length ? meeting.action_items.map((item, i) => <tr key={i}><td className="px-6 py-4 font-medium">{item.task}</td><td className="px-6 py-4">{item.assignee}</td><td className="px-6 py-4">{item.deadline ? new Date(item.deadline).toLocaleDateString('id-ID') : '-'}</td><td className="px-6 py-4">{item.status === 'done' ? <span className="text-green-600 flex items-center gap-1"><CheckCircle size={12}/> Selesai</span> : <span className="text-yellow-600 flex items-center gap-1"><Clock size={12}/> Proses</span>}</td></tr>) : <tr><td colSpan="4" className="px-6 py-8 text-center text-gray-400 italic">Tidak ada tindak lanjut.</td></tr>}</tbody></table></div>)}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [selectedMeetingId, setSelectedMeetingId] = useState(null);
            const [meetings, setMeetings] = useState([]);
            const [loading, setLoading] = useState(false);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            const [isDemoMode, setIsDemoMode] = useState(false);

            // Auth Listener
            useEffect(() => {
                if (auth) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        if (u) { setUser(u); setIsDemoMode(false); }
                        else if (!isDemoMode) setUser(null);
                    });
                    return () => unsubscribe();
                }
            }, [auth]);

            // Data Fetcher
            const fetchMeetings = async () => {
                if (!user && !isDemoMode) return;
                setLoading(true);
                try {
                    if (isDemoMode || !db) {
                        setMeetings([
                            { id: 1, title: 'Rapat Evaluasi Idul Qurban 1445H', date: '2024-06-20T19:30:00', location: 'Aula Utama Yayasan', type: 'Rapat Evaluasi', status: 'completed', leader_name: 'Ust. Hasan Basri', agenda: ['Laporan Keuangan'], minutes: [], decisions: [], action_items: [] },
                            { id: 2, title: 'Persiapan Pembangunan Gedung Baru', date: '2024-07-05T13:00:00', location: 'Ruang Rapat Lt. 2', type: 'Rapat Pengurus', status: 'scheduled', leader_name: 'H. Ahmad Fauzi', agenda: [], minutes: [], decisions: [], action_items: [] }
                        ]);
                    } else {
                        const snap = await db.collection("meetings").orderBy("date", "desc").get();
                        setMeetings(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }
                } catch (err) {
                    console.error("Firestore Fetch Error:", err);
                    if (err.code === 'permission-denied') {
                        setErrorMsg("Akses Ditolak: Database terkunci. Harap ubah Firestore Rules di Firebase Console agar mengizinkan akses untuk pengguna login.");
                    } else {
                        setErrorMsg("Gagal mengambil data: " + err.message);
                    }
                } finally { setLoading(false); }
            };

            useEffect(() => { fetchMeetings(); }, [user, isDemoMode]);

            const handleLogin = async (email, password) => {
                setLoading(true); setErrorMsg(null);
                if (email === 'demo') {
                    setTimeout(() => { setUser({ email: 'demo@user.com', displayName: 'Demo Admin' }); setIsDemoMode(true); setLoading(false); }, 800);
                } else if (auth) {
                    try { await auth.signInWithEmailAndPassword(email, password); } 
                    catch (err) { 
                        console.error(err);
                        let msg = 'Login gagal: ' + err.message;
                        if(err.code === 'auth/network-request-failed') {
                            msg = "Gagal terhubung ke server. Periksa koneksi internet Anda. Jika menjalankan file lokal (file://), browser mungkin memblokir koneksi.";
                        }
                        setErrorMsg(msg);
                    } 
                    finally { setLoading(false); }
                } else {
                    setErrorMsg("Firebase belum siap."); setLoading(false);
                }
            };

            const handleLogout = async () => {
                if (auth && !isDemoMode) await auth.signOut();
                setUser(null); setIsDemoMode(false); setView('dashboard');
            };

            const handleCreateMeeting = async (newMeetingData) => {
                setLoading(true);
                try {
                    if (isDemoMode) {
                        const mockId = Math.random().toString(36).substr(2, 9);
                        setMeetings([{ id: mockId, ...newMeetingData }, ...meetings]);
                    } else if (db) {
                        await db.collection('meetings').add(newMeetingData);
                        fetchMeetings(); 
                    }
                    setView('dashboard');
                } catch (err) {
                    console.error("Firestore Create Error:", err);
                    if (err.code === 'permission-denied') {
                        alert("Gagal menyimpan: Akses Ditolak. Harap perbarui Firestore Rules.");
                    } else {
                        alert("Gagal menyimpan rapat: " + err.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const handleUpdateMeeting = async (updatedData) => {
                setLoading(true);
                try {
                    if (isDemoMode) {
                        setMeetings(meetings.map(m => m.id === updatedData.id ? updatedData : m));
                    } else if (db) {
                        await db.collection('meetings').doc(updatedData.id).update(updatedData);
                        fetchMeetings();
                    }
                    setView('detail');
                } catch (err) {
                    console.error("Update Error:", err);
                    alert("Gagal mengupdate notulen: " + err.message);
                } finally { setLoading(false); }
            };

            if (!user) return <Login onLogin={handleLogin} loading={loading} error={errorMsg} />;

            return (
                <div className="flex min-h-screen bg-gray-50">
                    <aside className={`fixed inset-y-0 left-0 bg-emerald-900 text-white w-64 transform transition-transform duration-300 z-30 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0`}>
                        <div className="p-6 border-b border-emerald-800 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <img src={LOGO_URL} className="w-10 h-10 rounded-full bg-white" alt="Logo" />
                                <div><h1 className="text-lg font-bold leading-tight">Miftahus Sunnah</h1><p className="text-xs text-emerald-300">Sistem Notulen Digital</p></div>
                            </div>
                            <button onClick={() => setSidebarOpen(false)} className="md:hidden text-emerald-300"><X size={24} /></button>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={() => setView('dashboard')} className={`w-full flex items-center px-4 py-3 rounded-lg transition-all ${view === 'dashboard' ? 'bg-emerald-800 shadow-lg' : 'hover:bg-emerald-800'}`}><LayoutDashboard className="mr-3" size={20} /> Dashboard</button>
                            <button onClick={() => setView('search')} className={`w-full flex items-center px-4 py-3 rounded-lg transition-all ${view === 'search' ? 'bg-emerald-800 shadow-lg' : 'hover:bg-emerald-800'}`}><Search className="mr-3" size={20} /> Cari Arsip</button>
                            <button onClick={() => setView('attachments')} className={`w-full flex items-center px-4 py-3 rounded-lg transition-all ${view === 'attachments' ? 'bg-emerald-800 shadow-lg' : 'hover:bg-emerald-800'}`}><FileBox className="mr-3" size={20} /> Kelola Lampiran</button>
                            <button onClick={() => setView('settings')} className={`w-full flex items-center px-4 py-3 rounded-lg transition-all ${view === 'settings' ? 'bg-emerald-800 shadow-lg' : 'hover:bg-emerald-800'}`}><Settings className="mr-3" size={20} /> Pengaturan</button>
                        </nav>
                        <div className="p-4 border-t border-emerald-800 bg-emerald-950">
                            <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-emerald-700 rounded-full flex items-center justify-center font-bold text-white border border-emerald-600">{user.email?.charAt(0).toUpperCase() || 'U'}</div><div className="overflow-hidden"><p className="text-sm font-medium truncate">{user.email}</p><p className="text-xs text-emerald-400">{isDemoMode ? 'Demo' : 'Admin'}</p></div></div>
                            <button onClick={handleLogout} className="w-full flex items-center justify-center px-4 py-2 bg-emerald-800 rounded-lg text-xs font-bold text-emerald-200 hover:bg-red-900 hover:text-white transition"><LogOut size={14} className="mr-2" /> KELUAR</button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="md:hidden bg-white border-b p-4 flex justify-between items-center shadow-sm z-20">
                            <div className="flex items-center gap-2">
                                <img src={LOGO_URL} className="w-8 h-8 rounded-full" alt="Logo" />
                                <span className="font-bold text-gray-800">Miftahus Sunnah</span>
                            </div>
                            <button onClick={() => setSidebarOpen(true)} className="text-gray-600 bg-gray-100 p-2 rounded-md"><Menu size={24} /></button>
                        </header>
                        
                        <div className="flex-1 overflow-auto p-4 md:p-8">
                            <div className="max-w-6xl mx-auto">
                                {errorMsg && (
                                    <Alert type="error">
                                        <span className="font-bold">Error:</span> {errorMsg}
                                    </Alert>
                                )}

                                {view === 'dashboard' && (
                                    <div className="animate-fade-in">
                                        <div className="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                                            <div><h2 className="text-2xl font-bold text-gray-900">Dashboard</h2><p className="text-gray-500 mt-1">Selamat datang kembali, {user.email}</p></div>
                                            <button onClick={() => setView('create')} className="bg-emerald-600 text-white px-5 py-2.5 rounded-lg flex items-center hover:bg-emerald-700 transition shadow-lg font-medium"><Plus size={18} className="mr-2" /> Buat Rapat Baru</button>
                                        </div>
                                        <DashboardStats meetings={meetings} />
                                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                            <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50"><h3 className="font-bold text-gray-800">Daftar Rapat Terbaru</h3><button className="text-emerald-600 text-sm font-medium hover:underline">Lihat Semua</button></div>
                                            <div className="divide-y divide-gray-100">
                                                {loading ? <div className="p-8 text-center text-gray-500">Memuat data...</div> : meetings.length === 0 ? <div className="p-8 text-center text-gray-500">Belum ada data rapat.</div> : meetings.map(meeting => (
                                                    <div key={meeting.id} onClick={() => { setSelectedMeetingId(meeting.id); setView('detail'); }} className="p-5 hover:bg-blue-50/30 cursor-pointer transition flex flex-col md:flex-row md:items-center justify-between gap-4 group">
                                                        <div className="flex items-start gap-5">
                                                            <div className="bg-gray-100 p-3 rounded-xl text-center min-w-[70px] border border-gray-200"><p className="text-xs text-gray-500 uppercase font-bold">{new Date(meeting.date).toLocaleString('id-ID', { month: 'short' })}</p><p className="text-2xl font-bold text-gray-800">{new Date(meeting.date).getDate()}</p></div>
                                                            <div><h4 className="font-bold text-gray-800 text-lg group-hover:text-emerald-700">{meeting.title}</h4><div className="flex flex-wrap items-center text-sm text-gray-500 mt-1.5 gap-4"><span className="flex items-center"><Clock size={14} className="mr-1.5 text-gray-400"/> {new Date(meeting.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</span><span className="flex items-center"><MapPin size={14} className="mr-1.5 text-gray-400"/> {meeting.location}</span></div></div>
                                                        </div>
                                                        <div className="flex items-center gap-6 pl-20 md:pl-0"><div className="text-right hidden md:block"><p className="text-sm font-medium text-gray-900">{meeting.leader_name}</p><p className="text-xs text-gray-500">Pimpinan</p></div><StatusBadge status={meeting.status} /><ChevronRight size={20} className="text-gray-300 group-hover:text-emerald-500" /></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {view === 'detail' && <MeetingDetail meeting={meetings.find(m => m.id === selectedMeetingId)} onBack={() => setView('dashboard')} onEdit={() => setView('edit')} />}
                                {view === 'create' && <CreateMeetingForm onSave={handleCreateMeeting} onCancel={() => setView('dashboard')} loading={loading} />}
                                {view === 'edit' && <EditMeetingForm meeting={meetings.find(m => m.id === selectedMeetingId)} onSave={handleUpdateMeeting} onCancel={() => setView('detail')} loading={loading} />}
                                {view === 'search' && <SearchArchives meetings={meetings} onNavigateDetail={(id) => { setSelectedMeetingId(id); setView('detail'); }} />}
                                {view === 'attachments' && <ManageAttachments />}
                                {view === 'settings' && <SettingsPage user={user} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
